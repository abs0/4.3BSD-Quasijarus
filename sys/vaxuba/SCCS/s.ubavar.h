h09890
s 00026/00000/00244
d D 7.7 04/03/06 01:47:34 msokolov 45 44
c pnexus device autoconfiguration support
e
s 00013/00002/00231
d D 7.6 89/02/15 10:44:01 karels 44 43
c Berkeley copyright
e
s 00022/00006/00211
d D 7.5 88/10/20 17:03:01 karels 43 42
c change ubaalloc macros to allow 2047 map registers on Q-bus,
c use the macros, and add qbgetpri for Q-bus device probe routines
e
s 00008/00006/00209
d D 7.4 88/05/14 11:34:07 karels 42 41
c DWBUA support for 8200, other changes from torek
e
s 00004/00000/00211
d D 7.3 87/10/23 11:14:43 bostic 41 40
c ubago changed names; add bdp retention fields; (Chris Torek)
e
s 00011/00006/00200
d D 7.2 86/08/09 15:16:04 karels 40 39
c generalize uba code to handle Q bus more gracefully
e
s 00001/00001/00205
d D 7.1 86/06/05 01:19:56 mckusick 39 38
c 4.3BSD release version
e
s 00001/00000/00205
d D 6.6 86/02/17 22:48:47 karels 38 37
c add UBAI_ADDR
e
s 00003/00001/00202
d D 6.5 86/02/17 20:32:41 karels 37 36
c watch out for time going backward, keep zvtime per uba
e
s 00002/00002/00201
d D 6.4 85/08/05 19:28:55 bloom 36 35
c add support for 8600
e
s 00007/00001/00196
d D 6.3 85/06/08 14:44:07 mckusick 35 34
c Add copyright
e
s 00002/00000/00195
d D 6.2 85/01/18 11:02:34 karels 34 33
c changes to uba mem configuration: configure before device autoconfig
c on uba, and before device resets on uba reset; change zero-vector code
c for 780 to reset only on unacceptable zero-vector interrupt rate
e
s 00000/00000/00195
d D 6.1 83/08/13 12:40:16 sam 33 32
c 4.2 distribution
e
s 00006/00003/00189
d D 4.26 83/08/13 12:36:24 sam 32 30
c must define second bank of UNIBUS vectors for autoconf
e
s 00000/00000/00192
d R 6.1 83/07/29 07:29:47 sam 31 30
c 4.2 distribution
e
s 00002/00002/00190
d D 4.25 82/04/11 01:09:22 feldman 30 29
c support for ec driver
e
s 00001/00001/00191
d D 4.24 82/04/01 18:39:05 sam 29 28
c flags must be int to handle logical host kludge for network
e
s 00008/00000/00184
d D 4.23 81/11/26 11:54:41 wnj 28 27
c before carry to arpavax
e
s 00001/00001/00183
d D 4.22 81/11/20 14:28:04 wnj 27 26
c more lint
e
s 00005/00003/00179
d D 4.21 81/11/07 10:49:24 wnj 26 25
c shannons lastiv
e
s 00003/00003/00179
d D 4.20 81/10/29 20:52:04 wnj 25 24
c misc changes
e
s 00001/00000/00181
d D 4.19 81/08/31 01:13:10 wnj 24 23
c implement uh_errcnt
e
s 00000/00000/00181
d D 4.18 81/03/09 00:27:41 wnj 23 22
c lint
e
s 00113/00151/00068
d D 4.17 81/03/08 16:16:34 wnj 22 21
c split header files in 2 and rename structures for sanity
e
s 00004/00001/00215
d D 4.16 81/03/06 11:40:10 wnj 21 20
c spelling errors and add NEXFLT_BITS and UBASR_BITS
e
s 00012/00001/00204
d D 4.15 81/02/27 02:38:24 wnj 20 19
c dynamic alloc kernel version
e
s 00001/00001/00204
d D 4.14 81/02/26 22:07:35 wnj 19 18
c fixes for 750/780
e
s 00000/00002/00205
d D 4.13 81/02/26 04:29:55 wnj 18 17
c cosmetics
e
s 00000/00001/00207
d D 4.12 81/02/23 23:44:26 wnj 17 16
c get rid of uh_active
e
s 00001/00000/00207
d D 4.11 81/02/23 20:34:08 wnj 16 15
c add ud_xclu
e
s 00002/00000/00205
d D 4.10 81/02/22 21:47:19 wnj 15 14
c working interlocked version
e
s 00019/00020/00186
d D 4.9 81/02/21 21:29:46 wnj 14 13
c misc changes for first working interlockable version
e
s 00001/00001/00205
d D 4.8 81/02/19 21:42:45 wnj 13 12
c %G%->%E%
e
s 00027/00013/00179
d D 4.7 81/02/19 21:31:39 wnj 12 11
c various changes related to first dgo attempt
e
s 00023/00015/00169
d D 4.6 81/02/16 20:44:05 wnj 11 10
c more mods to working new version
e
s 00158/00118/00026
d D 4.5 81/02/15 12:14:20 wnj 10 9
c bootable autoconf version
e
s 00010/00007/00134
d D 4.4 81/02/07 15:54:02 wnj 9 8
c minor inconsequential changes
e
s 00008/00000/00133
d D 4.3 80/12/26 11:59:29 wnj 8 7
c add PHYSU* for standalone drivers
e
s 00009/00002/00124
d D 4.2 80/12/17 11:47:06 wnj 7 6
c combined 750/780
e
s 00000/00000/00126
d D 4.1 80/11/09 17:01:58 bill 6 5
c stamp for 4bsd
e
s 00003/00003/00123
d D 3.5 80/10/09 00:08:31 bill 5 4
c minor typos
e
s 00013/00000/00113
d D 3.4 80/06/22 12:39:43 bill 4 3
c added (as yet unused) structure describing ubaset() return value
e
s 00001/00001/00112
d D 3.3 80/06/07 03:01:45 bill 3 2
c %H%->%G%
e
s 00001/00001/00112
d D 3.2 80/04/11 10:20:14 bill 2 1
c 6pages kmap
e
s 00113/00000/00000
d D 3.1 80/04/09 16:25:45 bill 1 0
c date and time created 80/04/09 16:25:45 by bill
e
u
U
t
T
I 1
D 3
/*	%M%	%I%	%H%	*/
E 3
I 3
D 13
/*	%M%	%I%	%G%	*/
E 13
I 13
D 35
/*	%M%	%I%	%E%	*/
E 35
I 35
/*
D 39
 * Copyright (c) 1982 Regents of the University of California.
E 39
I 39
 * Copyright (c) 1982, 1986 Regents of the University of California.
E 39
D 44
 * All rights reserved.  The Berkeley software License Agreement
 * specifies the terms and conditions for redistribution.
E 44
I 44
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms are permitted
 * provided that the above copyright notice and this paragraph are
 * duplicated in all such forms and that any documentation,
 * advertising materials, and other materials related to such
 * distribution and use acknowledge that the software was developed
 * by the University of California, Berkeley.  The name of the
 * University may not be used to endorse or promote products derived
 * from this software without specific prior written permission.
 * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED
 * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.
E 44
 *
 *	%W% (Berkeley) %G%
 */
E 35
E 13
E 3

/*
D 10
 * Unibus adapter
E 10
I 10
D 12
 * unibus adapter
E 12
I 12
D 22
 * UNIBUS adaptor
E 22
I 22
 * This file contains definitions related to the kernel structures
 * for dealing with the unibus adapters.
 *
 * Each uba has a uba_hd structure.
 * Each unibus controller which is not a device has a uba_ctlr structure.
 * Each unibus device has a uba_device structure.
E 22
E 12
E 10
 */
I 11
D 22
#if VAX750
#define	UBA750	((struct uba_regs *)0xf30000)
#define	UMEM750	((u_short *)0xfc0000)
#endif
E 22
E 11

I 20
#ifndef LOCORE
E 20
D 2
#define	UBA0		0x80040000	/* sys virt i/o for UBA 0 */
E 2
I 2
D 10
#define	UBA0		0x80060000	/* sys virt i/o for UBA 0 */
E 2
#define	UBA0_DEV (UBA0+0x2000-0160000)	/* sys virt of device regs */
D 7

E 7
#define	UNIBASE 0760000	 		/* UNIBUS phys base of i/o reg's */

I 7
#if VAX==780
I 8
#define	PHYSUBA0	0x20006000
D 9
#define	PHYSUMEM	0x2013e000
E 9
I 9
#define	PHYSUDEV0	0x20100000
E 9
#else
#define	PHYSUBA0	0xf30000
D 9
#define	PHYSUMEM	(0xfc0000+UNIBASE)
E 9
I 9
#define	PHYSUDEV0	0xfc0000
E 9
#endif
I 9
#define	PHYSUMEM0	(PHYSUDEV0+0x3e000)
#define	PHYSUMEM	PHYSUMEM0
#define	PHYSUDEVSZ	0x40000
E 9

#if VAX==780
E 8
E 7
/* UBA Configuration Register, CNFGR */
#define	PARFLT		0x80000000	/* SBI Parity Fault */
#define	WSQFLT		0x40000000	/* SBI Write Sequence Fault */
#define	URDFLT		0x20000000	/* SBI Unexpected Read Fault */
#define	ISQFLT		0x10000000	/* SBI Interlock Sequence Fault */
#define	MXTFLT		0x8000000	/* SBI Multiple Transmitter Fault */
#define	XMTFLT		0x4000000	/* UBA is transmit faulter */
#define	ADPDN		0x800000	/* Adapter Power Down */
#define	ADPUP		0x400000	/* Adapter Power Up */
#define	UBINIT		0x40000		/* UNIBUS INIT is asserted */
#define	UBPDN		0x20000		/* UNIBUS Power Down */
#define	UBIC		0x10000		/* UNIBUS Initialization */
					/* UNIBUS Ready */
#define	UBACOD		0xff		/* UBA Code bits */
 
/* UBA Control Register, UBACR */
 
#define	MRD16		0x40000000	/* Map Reg Disable Bit 4 */
#define	MRD8		0x20000000	/* Map Reg Disable Bit 3 */
#define	MRD4		0x10000000	/* Map Reg Disable Bit 2 */
#define	MRD2		0x8000000	/* Map Reg Disable Bit 1 */
#define	MRD1		0x4000000	/* Map Reg Disable Bit 0 */
#define	IFS		0x40	  	/* Interrupt Field Switch */
#define	BRIE		0x20	  	/* BR Interrupt Enable */
#define	USEFIE		0x10	  	/* UNIBUS to SBI Error Field IE */
#define	SUEFIE		0x8	  	/* SBI to UNIBUS Error Field IE */
#define	CNFIE		0x4	  	/* Configuration IE */
#define	UPF		0x2	  	/* UNIBUS Power Fail */
#define	ADINIT		0x1	  	/* Adapter Init */
 
/* UBA Status Register, UASR */
#define	BR7FULL		0x8000000	/* BR7 Receive Vector Rg Full */
#define	BR6FULL		0x4000000	/* BR6 Receive Vector Reg Full */
#define	BR5FULL		0x2000000	/* BR5 Receive Vector Reg Full */
#define	BR4FULL		0x1000000	/* BR4 Receive Vector Reg Full */
#define	RDTO		0x400		/* UNIBUS to SBI Read Data Timeout */
#define	RDS		0x200		/* Read Data Substitute */
#define	CRD		0x100		/* Corrected Read Data */
#define	CXTER		0x80		/* Command Transmit Error */
#define	CXTMO		0x40		/* Command Transmit Timeout */
#define	DPPE		0x20		/* Data Path Parity Error */
#define	IVMR		0x10		/* Invalid Map Register */
#define	MRPF		0x8		/* Map Register Parity Failure */
#define	LEB		0x4		/* Lost Error */
#define	UBSTO		0x2		/* UNIBUS Select Timeout */
#define	UBSSTO		0x1		/* UNIBUS Slave Sync Timeout */
 
/* Failed Map Entry Register, FMER */
 
#define	FMRN		0x1ff		/* Failed Map Reg. No. Field */
 
/* Failed UNIBUS Address Register, FUBAR */
#define	FUA		0xffff		/* Failed UNIBUS Address Field */
 
/* BR Receive Vector register, BRRVR */
#define	AIRI		0x80000000	/* Adapter Interrupt Request */
#define	DIV		0xffff		/* Device Interrupt Vector Field */
I 7
#endif
E 7
 
/* Data Path Register, DPR */
#define	BNE		0x80000000	/* Buffer Not Empty - Purge */
#define	BTE		0x40000000	/* Buffer Transfer Error */
#define	DPF		0x20000000	/* DP Function (RO) */
#define	BS		0x7f0000	/* Buffer State Field */
#define	BUBA		0xffff		/* Buffered UNIBUS Address */
 
/* Map Register, MR */
#define	MRV		0x80000000	/* Map Register Valid */
D 5
#define	BO		0x2000000		/* Byte Offset Bit */
#define	DPDB		0x1e00000		/* Data Path Designator Field */
#define	SBIPFN		0xfffff			/* SBI Page Address Field */
E 5
I 5
#define	BO		0x2000000	/* Byte Offset Bit */
#define	DPDB		0x1e00000	/* Data Path Designator Field */
#define	SBIPFN		0xfffff		/* SBI Page Address Field */
E 5

E 10
I 10
D 19
#if VAX780
E 19
E 10
/*
D 10
 * Unibus maps
 */
D 9
#ifdef	KERNEL
#define	UAMSIZ 50

struct	map ubamap[UAMSIZ];
char	bdpwant;		/* someone is waiting for buffered data path */ 
E 9
D 7
struct	map bdpmap[15];
E 7
I 7
#if VAX==780
#define	NUBABDP	15
#else
#define	NUBABDP	3
#endif

I 9
#ifdef	KERNEL
#define	UAMSIZ 50

struct	map ubamap[UAMSIZ];
char	bdpwant;		/* someone is waiting for buffered data path */ 
E 9
struct	map bdpmap[NUBABDP];
E 7
char	umrwant;		/* ... for unibus map registers */
#endif

/*
E 10
D 22
 * UBA registers
E 22
I 22
 * Per-uba structure.
 *
 * This structure holds the interrupt vector for the uba,
 * and its address in physical and virtual space.  At boot time
 * we determine the devices attached to the uba's and their
 * interrupt vectors, filling in uh_vec.  We free the map
 * register and bdp resources of the uba into the structures
 * defined here.
 *
 * During normal operation, resources are allocated and returned
 * to the structures here.  We watch the number of passive releases
 * on each uba, and if the number is excessive may reset the uba.
 * 
 * When uba resources are needed and not available, or if a device
 * which can tolerate no other uba activity (rk07) gets on the bus,
 * then device drivers may have to wait to get to the bus and are
 * queued here.  It is also possible for processes to block in
 * the unibus driver in resource wait (mrwant, bdpwant); these
 * wait states are also recorded here.
E 22
 */
D 10

E 10
D 22
struct uba_regs
{
D 14
	int	uba_cnfgr;
	int	uba_cr;
	int	uba_sr;
	int	uba_dcr;
	int	uba_fmer;
	int	uba_fubar;
E 14
I 14
	int	uba_cnfgr;		/* configuration register */
	int	uba_cr;			/* control register */
	int	uba_sr;			/* status register */
	int	uba_dcr;		/* diagnostic control register */
	int	uba_fmer;		/* failed map entry register */
	int	uba_fubar;		/* failed UNIBUS address register */
E 14
	int	pad1[2];
	int	uba_brsvr[4];
D 14
	int	uba_brrvr[4];
	int	uba_dpr[16];
E 14
I 14
	int	uba_brrvr[4];		/* receive vector registers */
	int	uba_dpr[16];		/* buffered data path register */
E 14
	int	pad2[480];
D 14
	struct	pte uba_map[496];
I 10
	int	pad3[16];
E 14
I 14
	struct	pte uba_map[496];	/* unibus map register */
	int	pad3[16];		/* no maps for device address space */
E 22
I 22
struct	uba_hd {
D 40
	struct	uba_regs *uh_uba;	/* virt addr of uba */
	struct	uba_regs *uh_physuba;	/* phys addr of uba */
E 40
I 40
	int	uh_type;		/* type of adaptor */
	struct	uba_regs *uh_uba;	/* virt addr of uba adaptor regs */
	struct	uba_regs *uh_physuba;	/* phys addr of uba adaptor regs */
	struct	pte *uh_mr;		/* start of page map */
	int	uh_memsize;		/* size of uba memory, pages */
	caddr_t	uh_mem;			/* start of uba memory address space */
	caddr_t	uh_iopage;		/* start of uba io page */
E 40
	int	(**uh_vec)();		/* interrupt vector */
	struct	uba_device *uh_actf;	/* head of queue to transfer */
	struct	uba_device *uh_actl;	/* tail of queue to transfer */
	short	uh_mrwant;		/* someone is waiting for map reg */
	short	uh_bdpwant;		/* someone awaits bdp's */
	int	uh_bdpfree;		/* free bdp's */
	int	uh_hangcnt;		/* number of ticks hung */
D 37
	int	uh_zvcnt;		/* number of 0 vectors */
E 37
I 37
	int	uh_zvcnt;		/* number of recent 0 vectors */
	long	uh_zvtime;		/* time over which zvcnt accumulated */
	int	uh_zvtotal;		/* total number of 0 vectors */
E 37
I 24
	int	uh_errcnt;		/* number of errors */
I 26
	int	uh_lastiv;		/* last free interrupt vector */
E 26
E 24
	short	uh_users;		/* transient bdp use count */
	short	uh_xclu;		/* an rk07 is using this uba! */
I 34
	int	uh_lastmem;		/* limit of any unibus memory */
E 34
D 36
#define	UAMSIZ	25
E 36
I 36
#define	UAMSIZ	100
E 36
D 43
	struct	map *uh_map;		/* buffered data path regs free */
E 43
I 43
	struct	map *uh_map;		/* register free map */
E 43
E 22
E 14
E 10
};
I 20
D 22
#endif
E 22
E 20
I 4

I 42
/* given a pointer to uba_regs, find DWBUA registers */
/* this should be replaced with a union in uba_hd */
#define	BUA(uba)	((struct dwbua_regs *)(uba))

E 42
I 19
D 22
#if VAX780
E 19
D 10
union	ub_info {
	struct ub_Info {
	unsigned int	Ub_off:18,
			Ub_npf:10,
			Ub_bdp:4;
	} ub_I;
	int	ub_word;
E 10
I 10
/* UBA control register, UBACR */
#define	UBA_MRD16	0x40000000	/* map reg disable bit 4 */
#define	UBA_MRD8	0x20000000	/* map reg disable bit 3 */
#define	UBA_MRD4	0x10000000	/* map reg disable bit 2 */
#define	UBA_MRD2	0x08000000	/* map reg disable bit 1 */
#define	UBA_MRD1	0x04000000	/* map reg disable bit 0 */
#define	UBA_IFS		0x00000040	/* interrupt field switch */
#define	UBA_BRIE	0x00000020	/* BR interrupt enable */
#define	UBA_USEFIE	0x00000010	/* UNIBUS to SBI error field IE */
#define	UBA_SUEFIE	0x00000008	/* SBI to UNIBUS error field IE */
#define	UBA_CNFIE	0x00000004	/* configuration IE */
#define	UBA_UPF		0x00000002	/* UNIBUS power fail */
#define	UBA_ADINIT	0x00000001	/* adapter init */

/* UBA status register, UASR */
#define	UBA_BR7FULL	0x08000000	/* BR7 receive vector reg full */
#define	UBA_BR6FULL	0x04000000	/* BR6 receive vector reg full */
#define	UBA_BR5FULL	0x02000000	/* BR5 receive vector reg full */
#define	UBA_BR4FULL	0x01000000	/* BR4 receive vector reg full */
#define	UBA_RDTO	0x00000400	/* UNIBUS to SBI read data timeout */
#define	UBA_RDS		0x00000200	/* read data substitute */
#define	UBA_CRD		0x00000100	/* corrected read data */
#define	UBA_CXTER	0x00000080	/* command transmit error */
#define	UBA_CXTMO	0x00000040	/* command transmit timeout */
#define	UBA_DPPE	0x00000020	/* data path parity error */
#define	UBA_IVMR	0x00000010	/* invalid map register */
#define	UBA_MRPF	0x00000008	/* map register parity failure */
#define	UBA_LEB		0x00000004	/* lost error */
#define	UBA_UBSTO	0x00000002	/* UNIBUS select timeout */
D 21
#define	UBA_UBSSTO	0x00000001	/* UNIBUS slave sync timeout */
E 21
I 21
#define	UBA_UBSSYNTO	0x00000001	/* UNIBUS slave sync timeout */

#define	UBASR_BITS \
"\20\13RDTO\12RDS\11CRD\10CXTER\7CXTMO\6DPPE\5IVMR\4MRPF\3LEB\2UBSTO\1UBSSYNTO"
E 21

/* BR receive vector register, BRRVR */
#define	UBA_AIRI	0x80000000	/* adapter interrupt request */
#define	UBA_DIV		0x0000ffff	/* device interrupt vector field */
#endif
 
/* data path register, DPR */
#if VAX780
#define	UBA_BNE		0x80000000	/* buffer not empty - purge */
#define	UBA_BTE		0x40000000	/* buffer transfer error */
#define	UBA_DPF		0x20000000	/* DP function (RO) */
#define	UBA_BS		0x007f0000	/* buffer state field */
#define	UBA_BUBA	0x0000ffff	/* buffered UNIBUS address */
#endif
#if VAX750
D 14
#define	UBA_ERROR	0x20000000
#define	UBA_NXM		0x40000000
#define	UBA_UCE		0x20000000
#define	UBA_PURGE	0x00000001
E 14
I 14
#define	UBA_ERROR	0x80000000	/* error occurred */
#define	UBA_NXM		0x40000000	/* nxm from memory */
#define	UBA_UCE		0x20000000	/* uncorrectable error */
#define	UBA_PURGE	0x00000001	/* purge bdp */
E 14
#endif
 
/* map register, MR */
#define	UBA_MRV		0x80000000	/* map register valid */
#define	UBA_BO		0x02000000	/* byte offset bit */
#define	UBA_DPDB	0x01e00000	/* data path designator field */
#define	UBA_SBIPFN	0x000fffff	/* SBI page address field */

#define	UBA_DPSHIFT	21		/* shift to data path designator */

E 22
I 20
D 40
#ifndef LOCORE
E 40
E 20
/*
D 11
 * each UNIBUS mass storage controller has uba_minfo structure.
E 11
I 11
D 22
 * Each UNIBUS mass storage controller has uba_minfo structure,
 * and a uba_dinfo structure (as below) for each attached drive.
E 22
I 22
 * Per-controller structure.
 * (E.g. one for each disk and tape controller, and other things
 * which use and release buffered data paths.)
 *
 * If a controller has devices attached, then there are
 * cross-referenced uba_drive structures.
 * This structure is the one which is queued in unibus resource wait,
 * and saves the information about unibus resources which are used.
 * The queue of devices waiting to transfer is also attached here.
E 22
E 11
 */
D 12
struct	uba_minfo {
E 12
I 12
D 22
struct uba_minfo {
E 22
I 22
struct uba_ctlr {
E 22
E 12
D 11
	short	um_num;		/* controller index in driver */
E 11
I 11
	struct	uba_driver *um_driver;
	short	um_ctlr;	/* controller index in driver */
E 11
	short	um_ubanum;	/* the uba it is on */
	short	um_alive;	/* controller exists */
I 11
	int	(**um_intr)();	/* interrupt handler(s) */
E 11
	caddr_t	um_addr;	/* address of device in i/o space */
D 11
	struct	buf um_tab;	/* queue for this controller */
E 11
D 12
	struct	uba_info *um_forw;
E 12
I 11
	struct	uba_hd *um_hd;
I 22
/* the driver saves the prototype command here for use in its go routine */
E 22
I 12
	int	um_cmd;		/* communication to dgo() */
	int	um_ubinfo;	/* save unibus registers, etc */
I 41
	int	um_bdp;		/* for controllers that hang on to bdp's */
E 41
E 12
D 22
	struct	buf um_tab;	/* queue for this controller */
E 22
I 22
	struct	buf um_tab;	/* queue of devices for this controller */
E 22
E 11
E 10
};
I 22

E 22
I 10
/*
D 11
 * each UNIBUS device has a uba_dinfo structure.
 * controllers which are not for mass storage often have ONLY
 * a uba_dinfo structure, and no uba_minfo structure.
 * if a controller has many drives attached, then there will
 * be several uba_dinfo structures pointing at the same uba_minfo
E 11
I 11
D 22
 * Each UNIBUS device has a uba_dinfo structure.
E 22
I 22
 * Per ``device'' structure.
 * (A controller has devices or uses and releases buffered data paths).
 * (Everything else is a ``device''.)
 *
E 22
 * If a controller has many drives attached, then there will
D 22
 * be several uba_dinfo structures associated with a single uba_minfo
E 22
I 22
 * be several uba_device structures associated with a single uba_ctlr
E 22
E 11
 * structure.
I 22
 *
 * This structure contains all the information necessary to run
 * a unibus device such as a dz or a dh.  It also contains information
 * for slaves of unibus controllers as to which device on the slave
 * this is.  A flags field here can also be given in the system specification
 * and is used to tell which dz lines are hard wired or other device
 * specific parameters.
E 22
 */
D 12
struct	uba_dinfo {
E 12
I 12
D 22
struct uba_dinfo {
E 22
I 22
struct uba_device {
E 22
E 12
	struct	uba_driver *ui_driver;
D 11
	short	ui_name;
E 11
	short	ui_unit;	/* unit number on the system */
I 11
	short	ui_ctlr;	/* mass ctlr number; -1 if none */
E 11
	short	ui_ubanum;	/* the uba it is on */
	short	ui_slave;	/* slave on controller */
	int	(**ui_intr)();	/* interrupt handler(s) */
	caddr_t	ui_addr;	/* address of device in i/o space */
I 12
	short	ui_dk;		/* if init 1 set to number for iostat */
D 22
	short	ui_flags;	/* param to device init. */
E 22
I 22
D 29
	short	ui_flags;	/* parameter from system specification */
E 29
I 29
	int	ui_flags;	/* parameter from system specification */
E 29
E 22
E 12
	short	ui_alive;	/* device exists */
	short	ui_type;	/* driver specific type information */
D 12
	short	ui_dk;		/* device number for iostat */
E 12
	caddr_t	ui_physaddr;	/* phys addr, for standalone (dump) code */
I 12
D 22
	struct	uba_dinfo *ui_forw;
E 12
D 14
/* if the driver isn't also a controller, this is the controller it is on */
E 14
I 14
/* if the device isn't also a controller, this is the controller it is on */
E 14
	struct	uba_minfo *ui_mi;
E 22
I 22
/* this is the forward link in a list of devices on a controller */
	struct	uba_device *ui_forw;
/* if the device is connected to a controller, this is the controller */
	struct	uba_ctlr *ui_mi;
E 22
	struct	uba_hd *ui_hd;
};
I 20
D 40
#endif
E 40
E 20
E 10

D 10
#define	ub_off	ub_I.Ub_off
#define	ub_npf	ub_I.Ub_npf
#define	ub_bdp	ub_I.Ub_bdp
E 10
I 10
D 22
#define	NUBA780	4
#define	NUBA750	1
#if VAX780
#define	MAXNUBA	4
#else
#define	MAXNUBA	1
#endif

I 20
#ifndef LOCORE
E 22
E 20
/*
I 45
 * uba_ctlr and uba_device structures are now being overloaded beyond UNIBUS
 * for VAXBI and other peripheral-nexus devices.  They are kept in lists
 * separate from the regular UNIBUS ones and are picked up by VAXBI/XMI/etc.
 * autoconf code.  The um_ubanum/ui_ubanum field is overloaded for matching
 * specific VAXBI or XMI nodes.  It's set to -1 if the device was configured
 * "at nexus?", in which case it'll match the first actual device found on the
 * machine, but the user can also tie it down as e.g. "at vaxbi0 node 5".  The
 * tie-down information is encoded in the um_ubanum/ui_ubanum field as follows:
 *
 *	 (4)  (6)  (6)
 *	----------------
 *	| C | BUS |NODE|
 *	----------------
 *
 * C is the nexus class (defined in vax/nexus.h), BUS is the number of the
 * VAXBI or XMI bus, NODE is the node number on the latter.
 */
#define	PNEXUS_TIE(c,b,n)	((c) << 12 | (b) << 6 | (n))

/*
E 45
D 11
 * header per uba.		CAUTION: size & offsets known in uba.m
E 11
I 11
D 22
 * This structure exists per-uba.
D 18
 *
 * N.B.: THE SIZE AND SHAPE OF THIS STRUCTURE IS KNOWN IN uba.m.
E 18
E 11
 */
struct	uba_hd {
D 17
	int	uh_active;		/* bit per device transferring */
E 17
	struct	uba_regs *uh_uba;	/* virt addr of uba */
	struct	uba_regs *uh_physuba;	/* phys addr of uba */
	int	(**uh_vec)();		/* interrupt vector */
D 12
	struct	uba_minfo *uh_actf;	/* head of queue to transfer */
	struct	uba_minfo *uh_actl;	/* tail of queue to transfer */
E 12
I 12
	struct	uba_dinfo *uh_actf;	/* head of queue to transfer */
	struct	uba_dinfo *uh_actl;	/* tail of queue to transfer */
E 12
	short	uh_mrwant;		/* someone is waiting for map reg */
	short	uh_bdpwant;		/* someone awaits bdp's */
	int	uh_bdpfree;		/* free bdp's */
	int	uh_hangcnt;		/* number of ticks hung */
	int	uh_zvcnt;		/* number of 0 vectors */
I 15
	short	uh_users;		/* transient bdp use count */
	short	uh_xclu;		/* an rk07 is using this uba! */
E 15
D 11
#define	UAMSIZ 50
	struct	map uh_map[UAMSIZ];
E 11
I 11
#define	UAMSIZ	50
	struct	map *uh_map;
E 11
D 20
} uba_hd[MAXNUBA];
E 20
I 20
};
#ifdef KERNEL
struct	uba_hd uba_hd[MAXNUBA];
#endif
E 20
D 12
#ifdef KERNEL
extern	struct	uba_minfo ubminit[];
extern	struct	uba_dinfo ubdinit[];
int	numuba;
#endif
E 12
/*
D 11
 * each unibus driver defines entries for a set of routines
E 11
I 11
 * Each UNIBUS driver defines entries for a set of routines
E 22
I 22
 * Per-driver structure.
 *
 * Each unibus driver defines entries for a set of routines
E 22
E 11
 * as well as an array of types which are acceptable to it.
I 22
 * These are used at boot time by the configuration program.
E 22
 */
struct uba_driver {
D 14
	int	(*ud_cntrlr)();		/* see if a driver is really there */
	int	(*ud_slave)();		/* see if a slave is there; init */
	int	(*ud_dgo)();		/* routine to stuff driver regs */
/* dgo is called back by the unibus (usu ubaalloc), when the bus is ready */
D 11
	short	ud_maxslave;		/* max number of slaves */
E 11
	short	ud_needexcl;		/* need exclusive use of uba (rk07) */
E 14
I 14
	int	(*ud_probe)();		/* see if a driver is really there */
	int	(*ud_slave)();		/* see if a slave is there */
	int	(*ud_attach)();		/* setup driver for a slave */
	int	(*ud_dgo)();		/* fill csr/ba to start transfer */
E 14
	u_short	*ud_addr;		/* device csr addresses */
D 12
	char	*ud_pname;
E 12
I 12
	char	*ud_dname;		/* name of a device */
E 12
D 11
	struct	uba_dinfo **ud_info;	/* backpointers to ubinit structs */
E 11
I 11
D 22
	struct	uba_dinfo **ud_dinfo;	/* backpointers to ubdinit structs */
E 22
I 22
	struct	uba_device **ud_dinfo;	/* backpointers to ubdinit structs */
E 22
I 12
	char	*ud_mname;		/* name of a controller */
E 12
D 22
	struct	uba_minfo **ud_minfo;	/* backpointers to ubminit structs */
E 22
I 22
	struct	uba_ctlr **ud_minfo;	/* backpointers to ubminit structs */
E 22
I 16
	short	ud_xclu;		/* want exclusive use of bdp's */
I 41
	short	ud_keepbdp;		/* hang on to bdp's once allocated */
E 41
I 34
	int	(*ud_ubamem)();		/* see if dedicated memory is present */
E 34
E 16
E 11
};
I 20
#endif
E 20

/*
D 22
 * unibus maps
E 22
I 22
 * Flags to UBA map/bdp allocation routines
E 22
 */
D 22
#define	NBDP780	15
#define	NBDP750	3
#define	MAXNBDP	15
E 22
I 22
D 25
#define	UBA_NEEDBDP	1		/* transfer needs a bdp */
#define	UBA_CANTWAIT	2		/* don't block me */
#define	UBA_NEED16	3		/* need 16 bit addresses only */
E 25
I 25
D 26
#define	UBA_NEEDBDP	0x1		/* transfer needs a bdp */
#define	UBA_CANTWAIT	0x2		/* don't block me */
#define	UBA_NEED16	0x4		/* need 16 bit addresses only */
E 26
I 26
#define	UBA_NEEDBDP	0x01		/* transfer needs a bdp */
#define	UBA_CANTWAIT	0x02		/* don't block me */
#define	UBA_NEED16	0x04		/* need 16 bit addresses only */
#define	UBA_HAVEBDP	0x08		/* use bdp specified in high bits */
E 26
E 25
E 22

I 28
/*
 * Macros to bust return word from map allocation routines.
I 43
 * SHOULD USE STRUCTURE TO STORE UBA RESOURCE ALLOCATION:
E 43
 */
D 43
#define	UBAI_BDP(i)	((int)(((unsigned)(i))>>28))
#define	UBAI_NMR(i)	((int)((i)>>18)&0x3ff)
#define	UBAI_MR(i)	((int)((i)>>9)&0x1ff)
#define	UBAI_BOFF(i)	((int)((i)&0x1ff))
I 38
#define	UBAI_ADDR(i)	((int)((i)&0x3ffff))	/* uba addr (boff+mr) */
E 43
I 43
#ifdef notyet
struct ubinfo {
	long	ub_addr;	/* unibus address: mr + boff */
	int	ub_nmr;		/* number of registers, 0 if empty */
	int	ub_bdp;		/* bdp number, 0 if none */
};
#define	UBAI_MR(i)	(((i) >> 9) & 0x7ff)	/* starting map register */
#define	UBAI_BOFF(i)	((i)&0x1ff)		/* page offset */
#else
#define	UBAI_BDP(i)	((int)(((unsigned)(i)) >> 28))
#define	BDPMASK		0xf0000000
#define	UBAI_NMR(i)	((int)((i) >> 20) & 0xff)	/* max 255 (=127.5K) */
#define	UBA_MAXNMR	255
#define	UBAI_MR(i)	((int)((i) >> 9) & 0x7ff)	/* max 2047 */
#define	UBA_MAXMR	2047
#define	UBAI_BOFF(i)	((int)((i) & 0x1ff))
#define	UBAI_ADDR(i)	((int)((i) & 0xfffff))	/* uba addr (boff+mr) */
#define	UBAI_INFO(off, mr, nmr, bdp) \
	(((bdp) << 28) | ((nmr) << 20) | ((mr) << 9) | (off))
#endif
E 43
E 38

E 28
D 22
#define	NUBMREG	496
E 22
I 22
#ifndef LOCORE
#ifdef KERNEL
I 41
#define	ubago(ui)	ubaqueue(ui, 0)

E 41
/*
 * UBA related kernel variables
 */
int	numuba;					/* number of uba's */
D 27
extern	struct	uba_hd uba_hd[];
E 27
I 27
struct	uba_hd uba_hd[];
E 27
E 22

/*
D 22
 * flags to uba map/bdp allocation routines
E 22
I 22
 * Ubminit and ubdinit initialize the mass storage controller and
 * device tables specifying possible devices.
E 22
 */
D 22
#define	UBA_NEEDBDP	1		/* transfer needs a bdp */
#define	UBA_CANTWAIT	2		/* don't block me */
#define	UBA_NEED16	3		/* need 16 bit addresses only */
E 22
I 22
extern	struct	uba_ctlr ubminit[];
extern	struct	uba_device ubdinit[];
I 45

/*
 * Similar structures are used for VAXBI and other peripheral-nexus devices.
 */
extern	struct	uba_ctlr pnexminit[];
extern	struct	uba_device pnexdinit[];
E 45
E 22
I 12

/*
D 22
 * UNIBUS related kernel variables
E 22
I 22
D 42
 * UNIbus device address space is mapped by UMEMmap
E 42
I 42
 * UNIBUS device address space is mapped by UMEMmap
E 42
 * into virtual address umem[][].
I 40
 * The IO page is mapped to the last 8K of each.
 * This should be enlarged for the Q22 bus.
E 40
E 22
 */
I 20
D 22
#ifndef LOCORE
E 20
#ifdef KERNEL
extern	struct	uba_minfo ubminit[];
extern	struct	uba_dinfo ubdinit[];
int	numuba;
extern	struct pte UMEMmap[MAXNUBA][16];
extern	char umem[MAXNUBA][16*NBPG];
extern	int (*UNIvec[])();
E 22
I 22
D 30
extern	struct pte UMEMmap[][16];	/* uba device addr pte's */
extern	char umem[][16*NBPG];		/* uba device addr space */
E 30
I 30
extern	struct pte UMEMmap[][512];	/* uba device addr pte's */
extern	char umem[][512*NBPG];		/* uba device addr space */
E 30

/*
D 32
 * Since some VAXen vector their first (and only) unibus interrupt
 * vector just adjacent to the system control block, we must
E 32
I 32
 * Since some VAXen vector their unibus interrupts
 * just adjacent to the system control block, we must
E 32
 * allocate space there when running on ``any'' cpu.  This space is
D 32
 * used for the vector for uba0 on all cpu's.
E 32
I 32
D 40
 * used for the vectors for uba0 and uba1 on all cpu's.
E 40
I 40
D 42
 * used for the vectors for uba0 and uba1 on all cpu's but 8600's.
E 42
I 42
 * used for the vectors for all ubas.
E 42
E 40
E 32
 */
D 42
extern	int (*UNIvec[])();			/* unibus vec for uba0 */
I 32
#if NUBA > 1
extern	int (*UNI1vec[])();			/* unibus vec for uba1 */
#endif
E 42
I 42
extern	int (*UNIvec[][128])();			/* unibus vec for ubas */
extern	int (*eUNIvec)();			/* end of unibus vec */
E 42
E 32

E 22
D 36
#if VAX780
E 36
I 36
#if defined(VAX780) || defined(VAX8600)
E 36
I 22
/*
D 40
 * On 780's, we must set the scb vectors for the nexus of the
E 40
I 40
 * On DW780's, we must set the scb vectors for the nexus of the
E 40
 * UNIbus adaptors to vector to locore unibus adaptor interrupt dispatchers
 * which make 780's look like the other VAXen.
 */
E 22
extern	Xua0int(), Xua1int(), Xua2int(), Xua3int();
I 20
D 22
#endif
E 20
#endif
#endif
E 22
I 22
#endif VAX780
#endif KERNEL
#endif !LOCORE
E 22
E 12
E 10
E 4
E 1
